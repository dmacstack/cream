
<html>
  <head>
    <title> CREAM Chat </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0-rc2/angular-material.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0-rc2/angular-material.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
      body {
        padding-top: 60px;
      }
      #round_button {
        border-radius: 5px;
        float:right;
      }
      #message_div {
        overflow: scroll;
        height: 300px;
      }
      
      .tabsdemoDynamicHeight md-content {
        background-color: transparent !important;
      }

      .tabsdemoDynamicHeight md-content md-tabs {
        background: #f6f6f6;
        border: 1px solid #e1e1e1;
      }

      .tabsdemoDynamicHeight md-content md-tabs md-tabs-wrapper {
        background: white;
      }

      .tabsdemoDynamicHeight md-content h1:first-child {
        margin-top: 0;
      }


      /*
      Copyright 2016 Google Inc. All Rights Reserved. 
      Use of this source code is governed by an MIT-style license that can be in foundin the LICENSE file at http://material.angularjs.org/license.
      */
    </style>
   
  
    <script>
    var socket = io.connect();

    var creamApp = angular.module('creamApp', ['ngRoute','ngMaterial']);
    creamApp.config(function($routeProvider){
      $routeProvider
      .when('/', {
        templateUrl: 'partials/login.html',
        controller: 'usersController'
      })
      .when('/chat', {
        templateUrl: 'partials/chat.html',
        controller: 'chatsController'
      })
      .when('/video', {
        templateUrl: 'partials/video.html',
        controller: 'chatsController'
      })
      .otherwise({
        templateUrl: 'partials/login.html',
        controller: 'usersController'
      });
    });
    
    //UserFactory 
    
      creamApp.factory('UserFactory', function($http, $location){

       var factory = {};
       var users = [];
        // users = [{name:'john'},{name:'jane'},{name:'joe'}];
       var currentUser = null;
        
        factory.addUser = function(user, callback){

          $http.post('/signup', user).then(function(response){
            console.log('**********************************************');
            console.log(response);
            console.log('**********************************************');
            currentUser = response.config.data.name;
            if (currentUser) {
              $location.path('/chat');
            }
            callback(currentUser);
          });
        };

        factory.loginUser = function(loginInfo, callback) {
          $http.post('/login', {user: loginInfo, socketID: socket.id}).then(function(response){
            console.log('**********************************************');
            console.log(response);
            console.log('**********************************************');
            currentUser = response.data.local.name;
            if (currentUser) {
              $location.path('/chat');
            }
            callback(currentUser);
          })
        }

        factory.getUser = function(callback){
          callback(currentUser);
        }
        
        return factory;
      });
    //ChatFactory
    
      creamApp.factory('ChatFactory', function($http, $location){
        factory = {};
        chats = [];
        return factory;
      });

      creamApp.controller('usersController', function($scope, $location, UserFactory) {

        // var socket = io.connect();
        var currentList;
        $scope.loginregview = "signup";

        $scope.addUser = function(user){
          UserFactory.addUser(user, function(userData){
              $scope.newUser = {};
              $location.path('/chat');
          });
        };

        UserFactory.getUser(function(userData){
          $scope.currentUser = userData;
        });

        $scope.loginUser = function(loginInfo) {
          UserFactory.loginUser(loginInfo, function(){
            $scope.getUser = {};
          });
        };



      });
     //chatController
     creamApp.controller('chatsController', function($scope, $location, UserFactory, ChatFactory) {
      console.log(socket.id);
        // var socket = io.connect();
        var currentlist;
        
        $scope.users = [];
        $scope.messages = [];
        $scope.text = '';

        UserFactory.getUser(function(currentUser){
          $scope.currentUser = currentUser;
          socket.emit('alive_user', currentUser);
          });

          socket.on('userList', function(incoming){
            console.log('*******************');
            console.log(incoming);
            $scope.users = incoming.clients;
            console.log('kelvin');
            console.log($scope.users);
            console.log('*******************');
          })

        socket.on('connect', function () {
          $scope.setName();
        });
      

        socket.on('message', function (msg) {
          $scope.messages.push(msg);
          $scope.$apply();
        });

        socket.on('roster', function (names) {
          $scope.roster = names;
          $scope.$apply();
        });

        $scope.send = function send() {
          var elem = document.getElementById('message_div');
          elem.scrollTop = elem.scrollHeight;
          console.log('Sending message:', $scope.text);
          socket.emit('message', $scope.text);
          $scope.text = "";

        };

        $scope.setName = function setName() {
          UserFactory.getUser(function(userData){
            $scope.currentUser = userData;
            socket.emit('identify', $scope.currentUser);
          });
        };
        
        $scope.selectChatRoom = function(){
          console.log($scope.newChat);
          socket.emit('room', $scope.newChat);
          $scope.newChat = {};
        }
    
        $scope.leaveRoom = function(){
          socket.emit('leaveRoom', {});
              
        }
        
      });

    </script>
  </head>
  <body ng-app = "creamApp">
    
    <a href="#/"> Login Page </a> | <a href="#/chat"> Chat </a> | <a href="#/video"> Video </a>
    <br><br>
    <div ng-view = "">
    <div id="container">
     
     </div>
    </div>


  </body>
</html>
