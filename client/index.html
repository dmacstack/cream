
<html>
  <head>
    <title> CREAM Chat </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"> <!-- load fontawesome -->
      <style>
      body {
        padding-top: 60px;
      }
      #round_button {
        border-radius: 5px;
        float:right;
      }
      #message_div {
        overflow: scroll;
        height: 300px;
      }
      
      
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-route.min.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!--<script src="../node_modules/socket.io/socket.io.js"></script>-->
    <script src="/socket.io/socket.io.js"></script>
  
    <script>
    var creamApp = angular.module('creamApp', ['ngRoute']);
    creamApp.config(function($routeProvider){
      $routeProvider
      .when('/', {
        templateUrl: 'partials/login.html',
        controller: 'usersController'
      })
      .when('/chat', {
        templateUrl: 'partials/chat.html',
        controller: 'chatsController'
      })
      .when('/video', {
        templateUrl: 'partials/video.html'
      })
      .otherwise({
        templateUrl: 'partials/login.html'
      });
    });
    
    //UserFactory 
    
      creamApp.factory('UserFactory', function($http, $location){
    

       var factory = {};
       var users = [];
        // users = [{name:'john'},{name:'jane'},{name:'joe'}];
       var currentUser = null;
        
        factory.addUser = function(user, callback){

          $http.post('/signup', user).then(function(response){
            currentUser = response.config.data.name;
            if (currentUser) {
              $location.path('/chat');
            }
            callback(currentUser);
          });
        };

        factory.loginUser = function(loginInfo, callback) {
          $http.post('/login', {user: loginInfo}).then(function(response){
            currentUser = response.data.local.name;
            if (currentUser) {
              $location.path('/chat');
            }
            callback(currentUser);
          })
        }

        factory.getUser = function(callback){
          callback(currentUser);
        }
        
        return factory;
      });

      creamApp.controller('usersController', function($scope, UserFactory) {
        $scope.addUser = function(user){
          UserFactory.addUser(user, function(){
              $scope.newUser = {};
          });
        };

          UserFactory.getUser(function(userData){
          $scope.currentUser = userData;
        });

        $scope.loginUser = function(loginInfo) {
          UserFactory.loginUser(loginInfo, function(){
            $scope.loginUser = {};
          });
        };
      });
      
    //ChatFactory
    
      creamApp.factory('ChatFactory', function($http, $location){
        factory = {};
        chats = [];
        return factory;
      });
        
      creamApp.controller('usersController', function($scope, $location, UserFactory){
       
        var socket = io.connect();
        var currentList;
        
        $scope.addUser = function(user){
          UserFactory.addUser(user, function(userData){
            $scope.newUser = {};
            $location.path('/chat');
          });
        }

        // UserFactory.getUser(function(currentUser){
        //   $scope.currentUser = currentUser;
        //   socket.emit('alive_user', currentUser);
        //   socket.on('update_list', function(incoming){
        //       currentList = document.getElementById('user_list');
        //       currentList.innerHTML = incoming.name + "<br/>";
        //     })
        //   })
      
        

      });

   
    //chatController
    
     creamApp.controller('chatsController', function($scope, $location, UserFactory, ChatFactory) {
        var socket = io.connect();
        var currentlist;
        
        $scope.users = [];
        $scope.messages = [];
        $scope.roster = [];
        $scope.text = '';

        UserFactory.getUser(function(currentUser){
          $scope.currentUser = currentUser;
          socket.emit('alive_user', currentUser);
          socket.on('userList', function(incoming){
            $scope.users = incoming.clients;
            console.log($scope.users);

            })
          })

        socket.on('connect', function () {
          $scope.setName();
        });
      

        socket.on('message', function (msg) {
          $scope.messages.push(msg);
          $scope.$apply();
        });

        socket.on('roster', function (names) {
          $scope.roster = names;
          $scope.$apply();
        });
        
      
        

        $scope.send = function send() {
          var elem = document.getElementById('message_div');
          elem.scrollTop = elem.scrollHeight;
          console.log('Sending message:', $scope.text);
          socket.emit('message', $scope.text);
          $scope.text = "";

        };

        $scope.setName = function setName() {
          UserFactory.getUser(function(userData){
            $scope.currentUser = userData;
            socket.emit('identify', $scope.currentUser);
          });
        };
        
        $scope.selectChatRoom = function(){
          console.log($scope.newChat);
          socket.emit('room', $scope.newChat);
          $scope.newChat = {};
        }
    
        $scope.leaveRoom = function(){
          socket.emit('leaveRoom', {});
              
        }
        
      });

    </script>
  </head>
  <body ng-app = "creamApp">
    
    <a href="#/"> Login Page </a> | <a href="#/chat"> Chat </a> | <a href="#/video"> Video </a>
    
    <div ng-view = "">
    <div id="container">
     
     </div>
    </div>


  </body>
</html>
